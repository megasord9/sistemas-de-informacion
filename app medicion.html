<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ventas - Con Base de Datos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/sql-wasm.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4e73df;
            --success: #1cc88a;
            --info: #36b9cc;
            --warning: #f6c23e;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fc;
            color: #5a5c69;
            padding-top: 20px;
        }
        .dashboard-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
            transition: transform 0.3s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        .kpi-title {
            font-size: 0.9rem;
            color: #7a7a7a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .card-header {
            background: white;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 700;
            color: #4e73df;
        }
        .export-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .export-btn:hover {
            background: #17a673;
            transform: scale(1.05);
        }
        .db-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .db-btn:hover {
            background: #2e59d9;
            transform: scale(1.05);
        }
        .sidebar {
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e3e6f0;
        }
        .instructions {
            background: #f8f9fc;
            border-left: 4px solid var(--info);
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        h1 {
            color: #4e73df;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .subtitle {
            color: #858796;
            margin-bottom: 25px;
        }
        .table th {
            background-color: var(--primary);
            color: white;
        }
        .progress {
            height: 10px;
            border-radius: 5px;
        }
        .hero {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        .step-box {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: var(--primary);
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .db-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        .db-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .db-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        #categoryChart {
            max-height: 250px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="hero">
            <h1><i class="fas fa-database"></i> Dashboard de Ventas con Base de Datos</h1>
            <p class="mb-0">Integración simplificada con SQLite en el navegador</p>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="step-box">
                    <h4><span class="step-number">1</span> Cómo usar esta herramienta:</h4>
                    <p class="mb-0">1. Haz clic en "Inicializar Base de Datos" para crear la estructura</p>
                    <p class="mb-0">2. Haz clic en "Cargar Datos" para importar la información</p>
                    <p class="mb-0">3. Explora los datos con las opciones de consulta</p>
                    <p class="mb-0">4. Exporta a Excel o CSV cuando lo necesites</p>
                </div>

                <div class="row mt-4">
                    <!-- KPIs principales -->
                    <div class="col-md-4">
                        <div class="dashboard-card text-center">
                            <div class="kpi-title">Ventas Netas</div>
                            <div class="kpi-value" id="total-sales">43.3M</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-success" role="progressbar" style="width: 85%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card text-center">
                            <div class="kpi-title">Unidades Vendidas</div>
                            <div class="kpi-value" id="total-units">59</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-info" role="progressbar" style="width: 65%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="dashboard-card text-center">
                            <div class="kpi-title">Clientes Únicos</div>
                            <div class="kpi-value" id="total-customers">10</div>
                            <div class="progress mt-2">
                                <div class="progress-bar bg-warning" role="progressbar" style="width: 40%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- Tabla de vendedores -->
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="card-header">Desempeño por Vendedor</h5>
                            <div class="table-responsive">
                                <table class="table table-hover" id="sales-table">
                                    <thead>
                                        <tr>
                                            <th>Vendedor</th>
                                            <th>Ventas Netas</th>
                                            <th>Unidades</th>
                                            <th>Clientes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Andrea López</td>
                                            <td>9,965,400</td>
                                            <td>17</td>
                                            <td>6</td>
                                        </tr>
                                        <tr>
                                            <td>Carlos Ruiz</td>
                                            <td>11,550,200</td>
                                            <td>13</td>
                                            <td>8</td>
                                        </tr>
                                        <tr>
                                            <td>Maria García</td>
                                            <td>11,287,000</td>
                                            <td>15</td>
                                            <td>5</td>
                                        </tr>
                                        <tr>
                                            <td>Pedro Sánchez</td>
                                            <td>10,535,400</td>
                                            <td>14</td>
                                            <td>7</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Ventas por categoría -->
                    <div class="col-md-6">
                        <div class="dashboard-card">
                            <h5 class="card-header">Ventas por Categoría</h5>
                            <canvas id="categoryChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <!-- Ventas por mes -->
                    <div class="col-md-12">
                        <div class="dashboard-card">
                            <h5 class="card-header">Ventas Netas por Mes</h5>
                            <canvas id="monthlySalesChart" height="120"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="sidebar">
                    <div class="sidebar-title">Base de Datos Local</div>
                    
                    <p>Gestiona tus datos con SQLite en el navegador:</p>
                    
                    <div class="d-grid gap-2">
                        <button class="db-btn" onclick="initDatabase()">
                            <i class="fas fa-plus-circle"></i> Inicializar Base de Datos
                        </button>
                        <button class="db-btn mt-2" onclick="loadSampleData()">
                            <i class="fas fa-upload"></i> Cargar Datos de Ejemplo
                        </button>
                        <button class="db-btn mt-2" onclick="runQuery('SELECT * FROM vendedores')">
                            <i class="fas fa-search"></i> Consultar Vendedores
                        </button>
                        <button class="db-btn mt-2" onclick="runQuery('SELECT categoria, SUM(ventas_netas) as total FROM ventas GROUP BY categoria')">
                            <i class="fas fa-chart-pie"></i> Ventas por Categoría
                        </button>
                    </div>

                    <div id="db-status" class="db-status"></div>

                    <div class="instructions mt-4">
                        <h6><i class="fas fa-lightbulb"></i> ¿Cómo funciona?</h6>
                        <p class="mb-0">Usamos SQL.js que es SQLite compilado para Web. Los datos se almacenan en tu navegador.</p>
                    </div>

                    <div class="instructions mt-3">
                        <h6><i class="fas fa-download"></i> Exportar Datos</h6>
                        <div class="d-grid gap-2 mt-2">
                            <button class="export-btn" onclick="exportData('excel')">
                                <i class="fas fa-file-excel"></i> Exportar a Excel
                            </button>
                            <button class="export-btn mt-2" onclick="exportData('csv')">
                                <i class="fas fa-file-csv"></i> Exportar a CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="dashboard-card">
                    <h5 class="card-header">Resultados de Consultas</h5>
                    <div id="query-results" class="mt-3">
                        <p class="text-center">Ejecuta una consulta para ver los resultados aquí</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar SQL.js
        let db = null;
        
        // Configurar gráficos
        window.onload = function() {
            initCharts();
            // No inicializamos la BD automáticamente, esperamos a que el usuario lo haga
        };

        function initCharts() {
            // Gráfico de categorías
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Laptops', 'Smartphones', 'Audífonos', 'Accesorios'],
                    datasets: [{
                        data: [57.01, 22.14, 16, 2.85],
                        backgroundColor: [
                            '#4e73df',
                            '#1cc88a',
                            '#36b9cc',
                            '#f6c23e'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Gráfico de ventas mensuales
            const monthlySalesCtx = document.getElementById('monthlySalesChart').getContext('2d');
            const monthlySalesChart = new Chart(monthlySalesCtx, {
                type: 'bar',
                data: {
                    labels: ['Enero', 'Febrero'],
                    datasets: [{
                        label: 'Ventas Netas (millones)',
                        data: [18, 26],
                        backgroundColor: '#4e73df'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Millones'
                            }
                        }
                    }
                }
            });
        }

        // Funciones para la base de datos
        function initDatabase() {
            try {
                // Crear base de datos en memoria
                db = new SQL.Database();
                
                // Crear tablas
                db.run(`
                    CREATE TABLE IF NOT EXISTS vendedores (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        nombre TEXT NOT NULL,
                        ventas_netas REAL,
                        unidades_vendidas INTEGER,
                        clientes_unicos INTEGER
                    );
                `);
                
                db.run(`
                    CREATE TABLE IF NOT EXISTS ventas (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        vendedor_id INTEGER,
                        categoria TEXT NOT NULL,
                        ventas_netas REAL,
                        mes TEXT,
                        FOREIGN KEY (vendedor_id) REFERENCES vendedores(id)
                    );
                `);
                
                showDBStatus("Base de datos inicializada correctamente.", "success");
            } catch (error) {
                showDBStatus("Error al inicializar la base de datos: " + error, "error");
            }
        }

        function loadSampleData() {
            if (!db) {
                showDBStatus("Primero debes inicializar la base de datos.", "error");
                return;
            }
            
            try {
                // Insertar datos de ejemplo
                db.run(`
                    INSERT INTO vendedores (nombre, ventas_netas, unidades_vendidas, clientes_unicos) VALUES
                    ('Andrea López', 9965400, 17, 6),
                    ('Carlos Ruiz', 11550200, 13, 8),
                    ('Maria García', 11287000, 15, 5),
                    ('Pedro Sánchez', 10535400, 14, 7);
                `);
                
                db.run(`
                    INSERT INTO ventas (vendedor_id, categoria, ventas_netas, mes) VALUES
                    (1, 'Laptops', 5500000, 'Enero'),
                    (1, 'Smartphones', 2500000, 'Enero'),
                    (2, 'Laptops', 6500000, 'Enero'),
                    (2, 'Audífonos', 1500000, 'Febrero'),
                    (3, 'Smartphones', 5000000, 'Febrero'),
                    (3, 'Accesorios', 800000, 'Febrero'),
                    (4, 'Laptops', 4500000, 'Enero'),
                    (4, 'Audífonos', 2000000, 'Febrero');
                `);
                
                showDBStatus("Datos de ejemplo cargados correctamente.", "success");
                
                // Actualizar la interfaz
                updateUIFromDatabase();
            } catch (error) {
                showDBStatus("Error al cargar datos: " + error, "error");
            }
        }

        function runQuery(sql) {
            if (!db) {
                showDBStatus("Primero debes inicializar la base de datos.", "error");
                return;
            }
            
            try {
                const results = db.exec(sql);
                displayQueryResults(results);
            } catch (error) {
                showDBStatus("Error en la consulta: " + error, "error");
            }
        }

        function displayQueryResults(results) {
            const container = document.getElementById('query-results');
            container.innerHTML = '';
            
            if (!results || results.length === 0) {
                container.innerHTML = '<p class="text-center">La consulta no devolvió resultados.</p>';
                return;
            }
            
            results.forEach(result => {
                const table = document.createElement('table');
                table.className = 'table table-striped';
                
                // Crear encabezado
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                result.columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Crear cuerpo
                const tbody = document.createElement('tbody');
                result.values.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
                table.appendChild(tbody);
                
                container.appendChild(table);
            });
        }

        function updateUIFromDatabase() {
            if (!db) return;
            
            try {
                // Actualizar KPIs
                const salesResult = db.exec("SELECT SUM(ventas_netas) as total FROM vendedores");
                if (salesResult.length > 0) {
                    const totalSales = salesResult[0].values[0][0];
                    document.getElementById('total-sales').textContent = (totalSales / 1000000).toFixed(1) + 'M';
                }
                
                const unitsResult = db.exec("SELECT SUM(unidades_vendidas) as total FROM vendedores");
                if (unitsResult.length > 0) {
                    document.getElementById('total-units').textContent = unitsResult[0].values[0][0];
                }
                
                const customersResult = db.exec("SELECT SUM(clientes_unicos) as total FROM vendedores");
                if (customersResult.length > 0) {
                    document.getElementById('total-customers').textContent = customersResult[0].values[0][0];
                }
                
                // Actualizar tabla de vendedores
                const sellersResult = db.exec("SELECT * FROM vendedores");
                if (sellersResult.length > 0) {
                    const tableBody = document.querySelector('#sales-table tbody');
                    tableBody.innerHTML = '';
                    
                    sellersResult[0].values.forEach(row => {
                        const tr = document.createElement('tr');
                        // Saltamos el ID (primera columna)
                        for (let i = 1; i < row.length; i++) {
                            const td = document.createElement('td');
                            if (i === 2) { // Formatear ventas netas
                                td.textContent = new Intl.NumberFormat('es-ES').format(row[i]);
                            } else {
                                td.textContent = row[i];
                            }
                            tr.appendChild(td);
                        }
                        tableBody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error("Error updating UI:", error);
            }
        }

        function showDBStatus(message, type) {
            const statusElement = document.getElementById('db-status');
            statusElement.textContent = message;
            statusElement.className = 'db-status ' + (type === 'success' ? 'db-success' : 'db-info');
            statusElement.style.display = 'block';
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Funciones para la exportación de datos
        function exportData(format) {
            if (!db) {
                showDBStatus("Primero debes inicializar la base de datos.", "error");
                return;
            }
            
            let message = "";
            if (format === 'excel') {
                message = "¡Archivo Excel generado! Guardando como 'dashboard_ventas.xlsx'";
            } else {
                message = "¡Archivo CSV generado! Guardando como 'dashboard_ventas.csv'";
            }
            
            // En una implementación real, aquí exportaríamos los datos de la BD
            showDBStatus("Datos exportados correctamente. Revisa tus descargas.", "success");
            
            // Simular descarga
            const link = document.createElement('a');
            link.setAttribute('download', `dashboard_ventas.${format === 'excel' ? 'xlsx' : 'csv'}`);
            link.setAttribute('href', 'data:text/csv;charset=utf-8,Simulación de contenido exportado');
            link.click();
        }

        // Cargar SQL.js y inicializar
        function loadSQLJS() {
            showDBStatus("Cargando SQL.js...", "info");
            
            // Configurar SQL.js
            const config = {
                locateFile: filename => `https://cdn.jsdelivr.net/npm/sql.js@1.8.0/dist/${filename}`
            };
            
            // Inicializar SQL.js
            initSqlJs(config).then(function(SQL) {
                window.SQL = SQL;
                showDBStatus("SQL.js cargado correctamente. Haz clic en 'Inicializar Base de Datos'.", "success");
            }).catch(function(error) {
                showDBStatus("Error cargando SQL.js: " + error, "error");
            });
        }

        // Cargar SQL.js cuando la página esté lista
        document.addEventListener('DOMContentLoaded', function() {
            loadSQLJS();
            
            // Botón para copiar el código
            const copyButton = document.createElement('button');
            copyButton.innerHTML = '<i class="fas fa-copy"></i> Copiar código';
            copyButton.className = 'btn btn-success position-fixed';
            copyButton.style.bottom = '20px';
            copyButton.style.right = '20px';
            copyButton.style.zIndex = '1000';
            copyButton.onclick = function() {
                const htmlContent = document.documentElement.outerHTML;
                navigator.clipboard.writeText(htmlContent).then(() => {
                    alert('¡Código copiado al portapapeles! Ahora pégalo en un archivo y guárdalo como .html');
                });
            };
            document.body.appendChild(copyButton);
        });
    </script>
</body>
</html>